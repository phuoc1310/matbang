<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang t√†i kho·∫£n - SpaceRent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "primary-hover": "#0f6bd0",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                        "border-light": "#e2e8f0",
                        "border-dark": "#334155",
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white">T√†i kho·∫£n c·ªßa t√¥i</h1>
            <div class="flex gap-3">
                <a id="admin-link" href="admin.html" class="hidden flex items-center gap-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold transition-colors">
                    <span class="material-symbols-outlined text-[20px]">admin_panel_settings</span>
                    <span>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
                </a>
                <a href="Trangchu.html" class="flex items-center gap-2 px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-semibold transition-colors">
                    <span class="material-symbols-outlined text-[20px]">home</span>
                    <span>V·ªÅ trang ch·ªß</span>
                </a>
                <button id="logout-btn" class="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-colors">
                    <span class="material-symbols-outlined text-[20px]">logout</span>
                    <span>ƒêƒÉng xu·∫•t</span>
                </button>
            </div>
        </div>
        
        <!-- Error/Success Message -->
        <div id="message-container" class="hidden mb-4 p-4 rounded-lg text-sm font-medium"></div>
        
        <!-- Main Content -->
        <div id="main-content" class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-lg overflow-hidden">
            <!-- Tabs Navigation -->
            <div class="border-b border-border-light dark:border-border-dark">
                <div class="flex overflow-x-auto">
                    <button class="tab-btn active px-6 py-4 font-semibold text-sm border-b-2 border-primary text-primary dark:text-primary transition-colors whitespace-nowrap" data-tab="profile">
                        <span class="material-symbols-outlined text-[18px] align-middle mr-2">person</span>
                        Th√¥ng tin c√° nh√¢n
                    </button>
                    <button class="tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors whitespace-nowrap" data-tab="edit">
                        <span class="material-symbols-outlined text-[18px] align-middle mr-2">edit</span>
                        Ch·ªânh s·ª≠a th√¥ng tin
                    </button>
                    <button class="tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors whitespace-nowrap" data-tab="password">
                        <span class="material-symbols-outlined text-[18px] align-middle mr-2">lock</span>
                        ƒê·ªïi m·∫≠t kh·∫©u
                    </button>
                    <button class="tab-btn px-6 py-4 font-semibold text-sm border-b-2 border-transparent text-slate-600 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors whitespace-nowrap" data-tab="vip">
                        <span class="material-symbols-outlined text-[18px] align-middle mr-2">star</span>
                        N√¢ng c·∫•p VIP
                    </button>
                </div>
            </div>
            
            <!-- Tab Content -->
            <div class="p-6 md:p-8">
                <!-- Tab 1: Th√¥ng tin c√° nh√¢n -->
                <div id="tab-profile" class="tab-content">
                    <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white">Th√¥ng tin t√†i kho·∫£n</h2>
                    <div id="user-info" class="space-y-4"></div>
                </div>
                
                <!-- Tab 2: Ch·ªânh s·ª≠a th√¥ng tin -->
                <div id="tab-edit" class="tab-content hidden">
                    <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white">Ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n</h2>
                    <form id="edit-profile-form" class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">H·ªç v√† t√™n</label>
                                <input type="text" id="edit-fullName" class="w-full px-4 py-2.5 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="Nh·∫≠p h·ªç v√† t√™n">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" id="edit-phone" class="w-full px-4 py-2.5 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Email</label>
                            <input type="email" id="edit-email" class="w-full px-4 py-2.5 border border-border-light dark:border-border-dark rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed" value="" disabled>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Email kh√¥ng th·ªÉ thay ƒë·ªïi</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">ƒê·ªãa ch·ªâ</label>
                            <input type="text" id="edit-address" class="w-full px-4 py-2.5 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Vai tr√≤</label>
                            <input type="text" class="w-full px-4 py-2.5 border border-border-light dark:border-border-dark rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 cursor-not-allowed" value="" id="edit-role" disabled>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="px-6 py-2.5 bg-primary hover:bg-primary-hover text-white rounded-lg font-semibold transition-colors flex items-center gap-2">
                                <span class="material-symbols-outlined text-[18px]">save</span>
                                <span>L∆∞u thay ƒë·ªïi</span>
                            </button>
                            <button type="button" id="cancel-edit-btn" class="px-6 py-2.5 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-semibold transition-colors">
                                H·ªßy
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Tab 3: ƒê·ªïi m·∫≠t kh·∫©u -->
                <div id="tab-password" class="tab-content hidden">
                    <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white">ƒê·ªïi m·∫≠t kh·∫©u</h2>
                    <form id="change-password-form" class="space-y-5 max-w-md">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                            <input type="password" id="old-password" class="w-full px-4 py-2.5 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">M·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="new-password" class="w-full px-4 py-2.5 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="confirm-password" class="w-full px-4 py-2.5 border border-border-light dark:border-border-dark rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="px-6 py-2.5 bg-primary hover:bg-primary-hover text-white rounded-lg font-semibold transition-colors flex items-center gap-2">
                                <span class="material-symbols-outlined text-[18px]">lock_reset</span>
                                <span>ƒê·ªïi m·∫≠t kh·∫©u</span>
                            </button>
                            <button type="button" id="cancel-password-btn" class="px-6 py-2.5 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-semibold transition-colors">
                                H·ªßy
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Tab 4: N√¢ng c·∫•p VIP -->
                <div id="tab-vip" class="tab-content hidden">
                    <h2 class="text-xl font-bold mb-6 text-slate-900 dark:text-white">N√¢ng c·∫•p VIP</h2>
                    <div id="vip-content"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PayOS SDK - Ph·∫£i load tr∆∞·ªõc c√°c script kh√°c -->
    <script src="https://cdn.payos.vn/payos-checkout/v1/stable/payos-initialize.js" 
            onerror="console.error('Kh√¥ng th·ªÉ load PayOS SDK t·ª´ CDN. C√≥ th·ªÉ do m·∫°ng ho·∫∑c CDN l·ªói.'); window.PayOSLoadError = true;"
            onload="console.log('‚úÖ PayOS SDK ƒë√£ load th√†nh c√¥ng'); window.PayOSLoaded = true;"></script>
    <script src="asset/js/auth.js"></script>
    <script src="asset/js/vip.js"></script>
    <script>
        // ƒê·ª£i PayOS SDK load xong tr∆∞·ªõc khi load payos-demo.js
        function waitForPayOS(callback, maxAttempts = 60) {
            // Ki·ªÉm tra nhi·ªÅu c√°ch PayOS c√≥ th·ªÉ ƒë∆∞·ª£c expose
            const isPayOSAvailable = typeof PayOS !== 'undefined' || 
                                     typeof window.PayOS !== 'undefined';
            
            if (isPayOSAvailable || window.PayOSLoaded) {
                if (!isPayOSAvailable && window.PayOSLoaded) {
                    console.warn('‚ö†Ô∏è PayOS SDK script ƒë√£ load nh∆∞ng PayOS object ch∆∞a s·∫µn s√†ng. S·∫Ω d√πng demo mode.');
                    console.log('üí° Tip: PayOS c√≥ th·ªÉ c·∫ßn th√™m th·ªùi gian ƒë·ªÉ kh·ªüi t·∫°o. H√£y ch·ªù th√™m v√†i gi√¢y.');
                } else {
                    console.log('‚úÖ PayOS SDK ƒë√£ s·∫µn s√†ng');
                }
                callback();
            } else if (window.PayOSLoadError) {
                console.error('‚ùå PayOS SDK kh√¥ng load ƒë∆∞·ª£c t·ª´ CDN. S·∫Ω d√πng demo mode.');
                callback(); // V·∫´n ti·∫øp t·ª•c ƒë·ªÉ d√πng demo mode
            } else if (maxAttempts > 0) {
                setTimeout(() => waitForPayOS(callback, maxAttempts - 1), 200);
            } else {
                console.warn('‚ö†Ô∏è PayOS SDK kh√¥ng load ƒë∆∞·ª£c sau 12 gi√¢y. C√≥ th·ªÉ do m·∫°ng ho·∫∑c CDN l·ªói. S·∫Ω d√πng demo mode.');
                console.log('üí° Kh√¥ng sao, h·ªá th·ªëng v·∫´n ho·∫°t ƒë·ªông v·ªõi ch·∫ø ƒë·ªô demo.');
                callback(); // V·∫´n ti·∫øp t·ª•c ƒë·ªÉ d√πng demo mode
            }
        }
        
        // ƒê·ª£i DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                waitForPayOS(loadPayOSScripts);
            });
        } else {
            waitForPayOS(loadPayOSScripts);
        }
        
        function loadPayOSScripts() {
            // Load payos-demo.js sau khi PayOS SDK ƒë√£ s·∫µn s√†ng (ho·∫∑c timeout)
            const script = document.createElement('script');
            script.src = 'asset/js/payos-demo.js';
            script.onload = () => {
                // Load payos-check.js sau payos-demo.js
                const checkScript = document.createElement('script');
                checkScript.src = 'asset/js/payos-check.js';
                document.body.appendChild(checkScript);
            };
            document.body.appendChild(script);
        }
    </script>
    <script>
        const user = getCurrentUser();
        const messageContainer = document.getElementById("message-container");
        const logoutBtn = document.getElementById("logout-btn");
        
        // ================== SHOW MESSAGE ==================
        function showMessage(message, type = "error") {
            messageContainer.textContent = message;
            messageContainer.className = `mb-4 p-4 rounded-lg text-sm font-medium ${
                type === "success" 
                    ? "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300" 
                    : "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300"
            }`;
            messageContainer.classList.remove("hidden");
            setTimeout(() => {
                messageContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
        
        function hideMessage() {
            messageContainer.classList.add("hidden");
        }
        
        // ================== CHECK AUTH ==================
        if (!user) {
            document.getElementById("main-content").innerHTML = '<div class="p-8 text-center"><p class="text-red-600 dark:text-red-400 mb-4">Ch∆∞a ƒëƒÉng nh·∫≠p. ƒêang chuy·ªÉn h∆∞·ªõng...</p></div>';
            logoutBtn.style.display = 'none';
            setTimeout(() => {
                window.location.href = 'dangnhap.html';
            }, 1500);
        } else {
            // ================== RENDER USER INFO ==================
            function renderUserInfo() {
                const userInfoDiv = document.getElementById("user-info");
                const roleText = user.role === 'chumattbang' ? 'Ch·ªß m·∫∑t b·∫±ng' : 'Ng∆∞·ªùi thu√™';
                const vipStatusInfo = checkVipStatus();
                let vipStatusBadge = '';
                if (vipStatusInfo.isVip) {
                    vipStatusBadge = `<span class="px-3 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-semibold">VIP (C√≤n ${vipStatusInfo.daysLeft} ng√†y)</span>`;
                } else {
                    vipStatusBadge = `<span class="px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 rounded-full text-xs font-semibold">Th∆∞·ªùng</span>`;
                }
                
                userInfoDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">H·ªç v√† t√™n</p>
                            <p class="text-base font-semibold text-slate-900 dark:text-white">${user.fullName || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                        </div>
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Email</p>
                            <p class="text-base font-semibold text-slate-900 dark:text-white">${user.email}</p>
                        </div>
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">S·ªë ƒëi·ªán tho·∫°i</p>
                            <p class="text-base font-semibold text-slate-900 dark:text-white">${user.phone || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                        </div>
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">ƒê·ªãa ch·ªâ</p>
                            <p class="text-base font-semibold text-slate-900 dark:text-white">${user.address || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                        </div>
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Vai tr√≤</p>
                            <p class="text-base font-semibold text-slate-900 dark:text-white">${roleText}</p>
                        </div>
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">Tr·∫°ng th√°i VIP</p>
                            <p class="text-base">${vipStatusBadge}</p>
                        </div>
                        ${vipStatusInfo.isVip ? `
                        <div class="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">VIP h·∫øt h·∫°n</p>
                            <p class="text-base font-semibold text-slate-900 dark:text-white">${formatDate(vipStatusInfo.expiryDate.toISOString())}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // ================== LOAD EDIT FORM ==================
            function loadEditForm() {
                document.getElementById("edit-fullName").value = user.fullName || '';
                document.getElementById("edit-phone").value = user.phone || '';
                document.getElementById("edit-email").value = user.email;
                document.getElementById("edit-address").value = user.address || '';
                document.getElementById("edit-role").value = user.role === 'chumattbang' ? 'Ch·ªß m·∫∑t b·∫±ng' : 'Ng∆∞·ªùi thu√™';
            }
            
            // ================== TAB SWITCHING ==================
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    
                    // Update buttons
                    tabButtons.forEach(b => {
                        b.classList.remove('active', 'border-primary', 'text-primary');
                        b.classList.add('border-transparent', 'text-slate-600', 'dark:text-slate-400');
                    });
                    btn.classList.add('active', 'border-primary', 'text-primary');
                    btn.classList.remove('border-transparent', 'text-slate-600', 'dark:text-slate-400');
                    
                    // Update content
                    tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(`tab-${targetTab}`).classList.remove('hidden');
                    
                    // Load form data when switching to edit tab
                    if (targetTab === 'edit') {
                        loadEditForm();
                    }
                    
                    // Load VIP content when switching to VIP tab
                    if (targetTab === 'vip') {
                        renderVipContent();
                    }
                    
                    hideMessage();
                });
            });
            
            // ================== RENDER VIP CONTENT ==================
            function renderVipContent() {
                const vipContent = document.getElementById('vip-content');
                const vipStatus = checkVipStatus();
                
                let vipStatusHtml = '';
                if (vipStatus.isVip) {
                    const expiryDate = formatDate(vipStatus.expiryDate.toISOString());
                    vipStatusHtml = `
                        <div class="mb-6 p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 text-3xl">star</span>
                                <div>
                                    <h3 class="font-bold text-yellow-900 dark:text-yellow-200">T√†i kho·∫£n VIP c·ªßa b·∫°n ƒëang ho·∫°t ƒë·ªông</h3>
                                    <p class="text-sm text-yellow-700 dark:text-yellow-300">H·∫øt h·∫°n v√†o: ${expiryDate} (C√≤n ${vipStatus.daysLeft} ng√†y)</p>
                                    ${vipStatus.daysLeft <= 7 ? '<p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">‚ö†Ô∏è VIP c·ªßa b·∫°n s·∫Øp h·∫øt h·∫°n! Gia h·∫°n ngay ƒë·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng.</p>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    vipStatusHtml = `
                        <div class="mb-6 p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-slate-400 text-3xl">info</span>
                                <div>
                                    <h3 class="font-semibold text-slate-900 dark:text-white">T√†i kho·∫£n th∆∞·ªùng</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">N√¢ng c·∫•p VIP ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªüng nhi·ªÅu ∆∞u ƒë√£i ƒë·∫∑c bi·ªát</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Render packages
                const packagesHtml = VIP_PACKAGES.map(pkg => {
                    const discountBadge = pkg.discount > 0 ? `
                        <div class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-bl-lg rounded-tr-lg">
                            -${pkg.discount}%
                        </div>
                    ` : '';
                    
                    const popularBadge = pkg.popular ? `
                        <div class="absolute top-2 left-2 bg-primary text-white text-xs font-bold px-3 py-1 rounded-full">
                            Ph·ªï bi·∫øn
                        </div>
                    ` : '';
                    
                    return `
                        <div class="relative p-6 bg-white dark:bg-slate-800 border-2 ${pkg.popular ? 'border-primary' : 'border-slate-200 dark:border-slate-700'} rounded-xl hover:shadow-lg transition-all">
                            ${discountBadge}
                            ${popularBadge}
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">${pkg.name}</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">${pkg.description}</p>
                            <div class="mb-4">
                                ${pkg.discount > 0 ? `
                                    <p class="text-sm text-slate-400 line-through">${formatCurrency(pkg.originalPrice)}</p>
                                ` : ''}
                                <p class="text-3xl font-bold text-primary">${formatCurrency(pkg.price)}</p>
                            </div>
                            <button onclick="selectVipPackage('${pkg.id}')" class="w-full px-4 py-2.5 ${pkg.popular ? 'bg-primary hover:bg-primary-hover' : 'bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600'} text-white rounded-lg font-semibold transition-colors">
                                ${vipStatus.isVip ? 'Gia h·∫°n' : 'Ch·ªçn g√≥i'}
                            </button>
                        </div>
                    `;
                }).join('');
                
                vipContent.innerHTML = `
                    ${vipStatusHtml}
                    <div>
                        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Ch·ªçn g√≥i VIP</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${packagesHtml}
                        </div>
                    </div>
                    <div class="mt-8 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <h4 class="font-semibold text-blue-900 dark:text-blue-200 mb-2">‚ú® ∆Øu ƒë√£i VIP</h4>
                        <ul class="text-sm text-blue-800 dark:text-blue-300 space-y-1">
                            <li>‚Ä¢ Tin ƒëƒÉng ƒë∆∞·ª£c ∆∞u ti√™n hi·ªÉn th·ªã</li>
                            <li>‚Ä¢ ƒêƒÉng tin kh√¥ng gi·ªõi h·∫°n</li>
                            <li>‚Ä¢ H·ªó tr·ª£ ∆∞u ti√™n 24/7</li>
                            <li>‚Ä¢ Badge VIP tr√™n h·ªì s∆°</li>
                        </ul>
                    </div>
                    ${renderTransactionHistory()}
                `;
            }
            
            // ================== RENDER TRANSACTION HISTORY ==================
            function renderTransactionHistory() {
                const transactions = getTransactionHistory();
                
                if (transactions.length === 0) {
                    return '';
                }
                
                const transactionsHtml = transactions.map(txn => {
                    const statusBadge = txn.status === 'completed' 
                        ? '<span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded text-xs font-semibold">Th√†nh c√¥ng</span>'
                        : '<span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded text-xs font-semibold">Th·∫•t b·∫°i</span>';
                    
                    return `
                        <tr class="border-b border-slate-200 dark:border-slate-700">
                            <td class="px-4 py-3 text-sm text-slate-900 dark:text-white">${txn.packageName}</td>
                            <td class="px-4 py-3 text-sm text-slate-600 dark:text-slate-400">${formatCurrency(txn.amount)}</td>
                            <td class="px-4 py-3 text-sm">${statusBadge}</td>
                            <td class="px-4 py-3 text-sm text-slate-600 dark:text-slate-400">${formatDate(txn.createdAt)}</td>
                        </tr>
                    `;
                }).join('');
                
                return `
                    <div class="mt-8">
                        <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">L·ªãch s·ª≠ giao d·ªãch</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full bg-white dark:bg-slate-800 rounded-lg">
                                <thead class="bg-slate-50 dark:bg-slate-900">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase">G√≥i</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase">S·ªë ti·ªÅn</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase">Tr·∫°ng th√°i</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase">Ng√†y</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transactionsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // ================== SELECT VIP PACKAGE ==================
            function selectVipPackage(packageId) {
                const result = purchaseVip(packageId);
                if (!result.success) {
                    showMessage(result.message, 'error');
                    return;
                }
                
                // L∆∞u order data t·∫°m
                localStorage.setItem(`payos_order_${result.orderCode}`, JSON.stringify({
                    packageId: packageId,
                    orderCode: result.orderCode,
                    amount: result.package.price
                }));
                
                // Hi·ªÉn th·ªã loading
                showMessage('ƒêang t·∫°o link thanh to√°n...', 'success');
                
                // T·∫°o payment link
                createPayOSPaymentLink({
                    orderCode: result.orderCode,
                    amount: result.package.price,
                    packageId: packageId,
                    description: `Thanh to√°n ${result.package.name}`
                }).then(paymentResult => {
                    if (paymentResult.success) {
                        console.log('Redirecting to:', paymentResult.checkoutUrl);
                        // Redirect to PayOS checkout
                        window.location.href = paymentResult.checkoutUrl;
                    } else {
                        showMessage(paymentResult.message || 'Kh√¥ng th·ªÉ t·∫°o link thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                    }
                }).catch(error => {
                    console.error('Error creating payment link:', error);
                    showMessage(error.message || 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                });
            }
            
            // Make functions global
            window.selectVipPackage = selectVipPackage;
            
            // ================== EDIT PROFILE FORM ==================
            document.getElementById("edit-profile-form").addEventListener("submit", (e) => {
                e.preventDefault();
                hideMessage();
                
                const fullName = document.getElementById("edit-fullName").value.trim();
                const phone = document.getElementById("edit-phone").value.trim();
                const address = document.getElementById("edit-address").value.trim();
                
                // Validate phone
                if (phone && !validatePhone(phone)) {
                    showMessage("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p 10-11 s·ªë.", "error");
                    return;
                }
                
                const result = updateCurrentUser({
                    fullName: fullName,
                    phone: phone,
                    address: address
                });
                
                if (result.success) {
                    // Update user object
                    Object.assign(user, result.user);
                    showMessage(result.message, "success");
                    renderUserInfo();
                    // Switch to profile tab after 1 second
                    setTimeout(() => {
                        document.querySelector('[data-tab="profile"]').click();
                    }, 1000);
                } else {
                    showMessage(result.message, "error");
                }
            });
            
            // Cancel edit button
            document.getElementById("cancel-edit-btn").addEventListener("click", () => {
                document.querySelector('[data-tab="profile"]').click();
            });
            
            // ================== CHANGE PASSWORD FORM ==================
            document.getElementById("change-password-form").addEventListener("submit", (e) => {
                e.preventDefault();
                hideMessage();
                
                const oldPassword = document.getElementById("old-password").value;
                const newPassword = document.getElementById("new-password").value;
                const confirmPassword = document.getElementById("confirm-password").value;
                
                // Validate
                if (newPassword !== confirmPassword) {
                    showMessage("M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp.", "error");
                    return;
                }
                
                if (!validatePassword(newPassword)) {
                    showMessage("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.", "error");
                    return;
                }
                
                const result = changePassword(oldPassword, newPassword);
                
                if (result.success) {
                    showMessage(result.message, "success");
                    // Clear form
                    document.getElementById("change-password-form").reset();
                    // Switch to profile tab after 1 second
                    setTimeout(() => {
                        document.querySelector('[data-tab="profile"]').click();
                    }, 1000);
                } else {
                    showMessage(result.message, "error");
                }
            });
            
            // Cancel password button
            document.getElementById("cancel-password-btn").addEventListener("click", () => {
                document.getElementById("change-password-form").reset();
                document.querySelector('[data-tab="profile"]').click();
            });
            
            // ================== LOGOUT ==================
            logoutBtn.addEventListener("click", () => {
                const result = logout();
                if (result.success) {
                    showMessage("ƒêƒÉng xu·∫•t th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...", "success");
                    logoutBtn.disabled = true;
                    logoutBtn.innerHTML = '<span class="material-symbols-outlined text-[20px]">hourglass_empty</span><span>ƒêang ƒëƒÉng xu·∫•t...</span>';
                    setTimeout(() => {
                        window.location.href = "dangnhap.html";
                    }, 800);
                } else {
                    showMessage("C√≥ l·ªói x·∫£y ra: " + result.message, "error");
                }
            });
            
            // ================== UPDATE USER OBJECT ==================
            function updateUserObject() {
                const updatedUser = getCurrentUser();
                if (updatedUser) {
                    Object.assign(user, updatedUser);
                }
            }
            
            // Initial render
            renderUserInfo();
            
            // Show admin link only if user is admin
            const adminLink = document.getElementById("admin-link");
            if (isAdmin()) {
                adminLink.classList.remove("hidden");
            }
            
            // Update user object periodically (for VIP status changes)
            setInterval(() => {
                updateUserObject();
                renderUserInfo();
            }, 5000);
        }
    </script>

    <!-- ================== CHATBOT AI WIDGET ================== -->
    <link rel="stylesheet" href="asset/css/chatbot.css">
    <button id="chatbot-toggle" aria-label="M·ªü chatbot h·ªó tr·ª£">
        <span class="material-symbols-outlined">support_agent</span>
    </button>
    <div id="chatbot-container">
        <div id="chatbot-header">
            <h3>
                <span class="material-symbols-outlined">smart_toy</span>
                Tr·ª£ l√Ω AI SpaceRent
            </h3>
            <button id="chatbot-close" aria-label="ƒê√≥ng chatbot">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="chatbot-messages"></div>
        <div id="chatbot-input-container">
            <textarea id="chatbot-input" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." rows="1"></textarea>
            <button id="chatbot-send" aria-label="G·ª≠i tin nh·∫Øn">
                <span class="material-symbols-outlined">send</span>
            </button>
        </div>
    </div>
    <script src="asset/js/chatbot.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initChatbot();
        });
    </script>
</body>
</html>
