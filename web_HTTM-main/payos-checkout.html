<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n PayOS - SpaceRent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "primary-hover": "#0f6bd0",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                        "border-light": "#e2e8f0",
                        "border-dark": "#334155",
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full">
        <div class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-primary to-primary-hover p-6 text-white text-center">
                <div class="flex items-center justify-center gap-3 mb-2">
                    <span class="material-symbols-outlined text-4xl">account_balance</span>
                    <h1 class="text-2xl font-bold">PayOS</h1>
                </div>
                <p class="text-sm opacity-90">H·ªá th·ªëng thanh to√°n tr·ª±c tuy·∫øn</p>
            </div>
            
            <!-- Content -->
            <div id="checkout-content" class="p-6">
                <!-- Loading state -->
                <div id="loading-state" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
                    <p class="text-slate-600 dark:text-slate-400">ƒêang x·ª≠ l√Ω thanh to√°n...</p>
                </div>
                
                <!-- Payment form -->
                <div id="payment-form" class="hidden">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Th√¥ng tin thanh to√°n</h2>
                        <p class="text-sm text-slate-600 dark:text-slate-400" id="order-info"></p>
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                            <div class="grid grid-cols-3 gap-3">
                                <button class="payment-method p-4 border-2 border-slate-200 dark:border-slate-700 rounded-lg hover:border-primary transition-colors" data-method="vnpay">
                                    <div class="text-2xl mb-1">üí≥</div>
                                    <div class="text-xs font-semibold">VNPay</div>
                                </button>
                                <button class="payment-method p-4 border-2 border-slate-200 dark:border-slate-700 rounded-lg hover:border-primary transition-colors" data-method="momo">
                                    <div class="text-2xl mb-1">üíú</div>
                                    <div class="text-xs font-semibold">MoMo</div>
                                </button>
                                <button class="payment-method p-4 border-2 border-slate-200 dark:border-slate-700 rounded-lg hover:border-primary transition-colors" data-method="zalopay">
                                    <div class="text-2xl mb-1">üíô</div>
                                    <div class="text-xs font-semibold">ZaloPay</div>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="pay-btn" class="flex-1 px-6 py-3 bg-primary hover:bg-primary-hover text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Thanh to√°n
                        </button>
                        <button id="cancel-btn" class="px-6 py-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-semibold transition-colors">
                            H·ªßy
                        </button>
                    </div>
                </div>
                
                <!-- Success state -->
                <div id="success-state" class="hidden text-center py-8">
                    <div class="mb-4">
                        <span class="material-symbols-outlined text-green-500 text-6xl">check_circle</span>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Thanh to√°n th√†nh c√¥ng!</h2>
                    <p class="text-slate-600 dark:text-slate-400 mb-6">VIP c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t th√†nh c√¥ng.</p>
                    <button id="back-btn" class="px-6 py-3 bg-primary hover:bg-primary-hover text-white rounded-lg font-semibold transition-colors">
                        V·ªÅ trang t√†i kho·∫£n
                    </button>
                </div>
                
                <!-- Error state -->
                <div id="error-state" class="hidden text-center py-8">
                    <div class="mb-4">
                        <span class="material-symbols-outlined text-red-500 text-6xl">error</span>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Thanh to√°n th·∫•t b·∫°i</h2>
                    <p class="text-slate-600 dark:text-slate-400 mb-6" id="error-message">ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh thanh to√°n.</p>
                    <button id="retry-btn" class="px-6 py-3 bg-primary hover:bg-primary-hover text-white rounded-lg font-semibold transition-colors mr-3">
                        Th·ª≠ l·∫°i
                    </button>
                    <button id="cancel-error-btn" class="px-6 py-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg font-semibold transition-colors">
                        H·ªßy
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PayOS SDK - Ph·∫£i load tr∆∞·ªõc c√°c script kh√°c -->
    <script src="https://cdn.payos.vn/payos-checkout/v1/stable/payos-initialize.js" 
            onerror="console.error('Kh√¥ng th·ªÉ load PayOS SDK t·ª´ CDN. C√≥ th·ªÉ do m·∫°ng ho·∫∑c CDN l·ªói.'); window.PayOSLoadError = true;"
            onload="console.log('‚úÖ PayOS SDK ƒë√£ load th√†nh c√¥ng'); window.PayOSLoaded = true;"></script>
    <script src="asset/js/auth.js"></script>
    <script src="asset/js/vip.js"></script>
    <script>
        // ƒê·ª£i PayOS SDK load xong tr∆∞·ªõc khi load payos-demo.js
        function waitForPayOS(callback, maxAttempts = 60) {
            // Ki·ªÉm tra nhi·ªÅu c√°ch PayOS c√≥ th·ªÉ ƒë∆∞·ª£c expose
            const isPayOSAvailable = typeof PayOS !== 'undefined' || 
                                     typeof window.PayOS !== 'undefined';
            
            if (isPayOSAvailable || window.PayOSLoaded) {
                if (!isPayOSAvailable && window.PayOSLoaded) {
                    console.warn('‚ö†Ô∏è PayOS SDK script ƒë√£ load nh∆∞ng PayOS object ch∆∞a s·∫µn s√†ng. S·∫Ω d√πng demo mode n·∫øu c·∫ßn.');
                } else {
                    console.log('‚úÖ PayOS SDK ƒë√£ s·∫µn s√†ng');
                }
                callback();
            } else if (window.PayOSLoadError) {
                console.warn('‚ö†Ô∏è PayOS SDK kh√¥ng load ƒë∆∞·ª£c t·ª´ CDN. S·∫Ω d√πng demo mode n·∫øu c·∫ßn.');
                callback(); // V·∫´n ti·∫øp t·ª•c ƒë·ªÉ d√πng demo mode
            } else if (maxAttempts > 0) {
                setTimeout(() => waitForPayOS(callback, maxAttempts - 1), 200);
            } else {
                console.warn('‚ö†Ô∏è PayOS SDK kh√¥ng load ƒë∆∞·ª£c sau 12 gi√¢y. S·∫Ω d√πng demo mode n·∫øu c·∫ßn.');
                callback(); // V·∫´n ti·∫øp t·ª•c ƒë·ªÉ d√πng demo mode
            }
        }
        
        // Load payos-demo.js sau khi PayOS SDK ƒë√£ s·∫µn s√†ng
        waitForPayOS(() => {
            const script = document.createElement('script');
            script.src = 'asset/js/payos-demo.js';
            script.onload = () => {
                // Sau khi payos-demo.js load xong, kh·ªüi t·∫°o checkout
                initCheckout();
            };
            document.body.appendChild(script);
        });
        
        // Kh·ªüi t·∫°o checkout logic
        function initCheckout() {
            // Get order data from URL
            const urlParams = new URLSearchParams(window.location.search);
            const orderCode = urlParams.get('orderCode');
            const amount = parseInt(urlParams.get('amount'));
            const packageId = urlParams.get('packageId');
            
            let selectedMethod = null;
            
            // Initialize
            if (!orderCode || !amount || !packageId) {
                showError('Th√¥ng tin ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá.');
                return;
            }
            
            // Show payment form after 1 second (simulate loading)
            setTimeout(() => {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('payment-form').classList.remove('hidden');
                
                // Format amount
                const formattedAmount = new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND'
                }).format(amount);
                
                document.getElementById('order-info').textContent = `S·ªë ti·ªÅn: ${formattedAmount}`;
            }, 1000);
            
            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(b => {
                        b.classList.remove('border-primary', 'bg-primary/10');
                    });
                    btn.classList.add('border-primary', 'bg-primary/10');
                    selectedMethod = btn.getAttribute('data-method');
                    document.getElementById('pay-btn').disabled = false;
                });
            });
            
            // Pay button
            document.getElementById('pay-btn').addEventListener('click', () => {
                if (!selectedMethod) {
                    alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n');
                    return;
                }
                
                processPayment();
            });
            
            // Cancel button
            document.getElementById('cancel-btn').addEventListener('click', () => {
                window.location.href = 'taikhoan.html';
            });
            
            // Back button
            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = 'taikhoan.html';
            });
            
            // Retry button
            document.getElementById('retry-btn').addEventListener('click', () => {
                window.location.reload();
            });
            
            // Cancel error button
            document.getElementById('cancel-error-btn').addEventListener('click', () => {
                window.location.href = 'taikhoan.html';
            });
            
            // Process payment
            function processPayment() {
                document.getElementById('payment-form').classList.add('hidden');
                document.getElementById('loading-state').classList.remove('hidden');
                
                // Simulate payment processing (2-3 seconds)
                setTimeout(async () => {
                    // Verify payment (demo: 90% success)
                    const isSuccess = Math.random() > 0.1;
                    
                    if (isSuccess) {
                        // Ch·ªâ g·ªçi handlePayOSCallback khi th√†nh c√¥ng
                        try {
                            const result = await handlePayOSCallback(orderCode, 'success');
                            
                            if (result.success) {
                                showSuccess();
                            } else {
                                showError(result.message);
                            }
                        } catch (error) {
                            console.error('L·ªói x·ª≠ l√Ω callback:', error);
                            showError('ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω thanh to√°n.');
                        }
                    } else {
                        // Thanh to√°n th·∫•t b·∫°i - KH√îNG g·ªçi handlePayOSCallback
                        // KH√îNG k√≠ch ho·∫°t VIP
                        showError('Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
                    }
                }, 2000 + Math.random() * 1000);
            }
            
            function showSuccess() {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('success-state').classList.remove('hidden');
            }
            
            function showError(message) {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').textContent = message;
            }
        }
    </script>
</body>
</html>
